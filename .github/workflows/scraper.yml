name: UFC Stats Scraper

on:
  # Run daily at 2:00 AM UTC (after most UFC events conclude)
  schedule:
    - cron: '0 2 * * *'

  # Allow manual triggering with optional event limit
  workflow_dispatch:
    inputs:
      limit:
        description: 'Limit number of events to scrape (leave empty for all)'
        required: false
        type: string
        default: ''

jobs:
  scrape-ufcstats:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'scraper/requirements.txt'

      - name: Install Python dependencies
        working-directory: ./scraper
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run UFC Stats scraper
        working-directory: ./scraper
        env:
          INGEST_API_URL: ${{ secrets.INGEST_API_URL }}
          INGEST_API_SECRET: ${{ secrets.INGEST_API_SECRET }}
        run: |
          if [ -n "${{ github.event.inputs.limit }}" ]; then
            echo "ðŸ¥Š Running UFC scraper with limit: ${{ github.event.inputs.limit }} events"
            scrapy crawl ufcstats -a limit=${{ github.event.inputs.limit }} -s LOG_LEVEL=INFO
          else
            echo "ðŸ¥Š Running UFC scraper for all events"
            scrapy crawl ufcstats -s LOG_LEVEL=INFO
          fi

      - name: Upload scraper logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scraper-logs-${{ github.run_number }}
          path: |
            scraper/*.log
            scraper/*.json
          retention-days: 7
          if-no-files-found: ignore

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::UFC scraper workflow failed"
          echo "Run number: ${{ github.run_number }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Check logs above for details"
