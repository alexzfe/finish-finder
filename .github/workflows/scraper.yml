name: UFC Stats Scraper

on:
  # Run daily at 2:00 AM UTC (after most UFC events conclude)
  schedule:
    - cron: '0 2 * * *'

  # Allow manual triggering with optional event limit and completed events
  workflow_dispatch:
    inputs:
      limit:
        description: 'Limit number of events to scrape (leave empty for all)'
        required: false
        type: string
        default: ''
      include_completed:
        description: 'Also scrape 2 most recent completed events with outcomes (true/false)'
        required: false
        type: boolean
        default: true

jobs:
  scrape-ufcstats:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'scraper/requirements.txt'

      - name: Install Python dependencies
        working-directory: ./scraper
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run UFC Stats scraper
        working-directory: ./scraper
        env:
          INGEST_API_URL: ${{ secrets.INGEST_API_URL }}
          INGEST_API_SECRET: ${{ secrets.INGEST_API_SECRET }}
        run: |
          # Build scraper command with optional parameters
          CMD="scrapy crawl ufcstats -s LOG_LEVEL=INFO"

          if [ -n "${{ github.event.inputs.limit }}" ]; then
            CMD="$CMD -a limit=${{ github.event.inputs.limit }}"
            echo "ü•ä Limit: ${{ github.event.inputs.limit }} events"
          else
            echo "ü•ä No limit (scraping all events)"
          fi

          # For scheduled runs, github.event.inputs is empty, so default to including completed events
          # For manual runs, respect the user's choice (defaults to true in workflow_dispatch)
          INCLUDE_COMPLETED="${{ github.event.inputs.include_completed }}"
          if [ -z "$INCLUDE_COMPLETED" ] || [ "$INCLUDE_COMPLETED" = "true" ]; then
            CMD="$CMD -a include_completed=true"
            echo "üìä Including 2 most recent completed events with outcomes"
          else
            echo "‚è∞ Upcoming events only"
          fi

          echo "Running: $CMD"
          $CMD

      - name: Upload scraper logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scraper-logs-${{ github.run_number }}
          path: |
            scraper/*.log
            scraper/*.json
          retention-days: 7
          if-no-files-found: ignore

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::UFC scraper workflow failed"
          echo "Run number: ${{ github.run_number }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Check logs above for details"
