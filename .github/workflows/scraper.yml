name: Automated Scraper

on:
  schedule:
    - cron: '0 2 * * *'  # Run daily at 2:00 AM UTC (after AI predictions at 1:30 AM)
  workflow_dispatch:        # Allow manual trigger
    inputs:
      events_limit:
        description: 'Number of events to process from Tapology (default: 10)'
        required: false
        default: '10'

jobs:
  run-scraper:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # Standard timeout for scraping
    permissions:
      contents: read
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Run automated scraper
        env:
          # Existing environment variables
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          SCRAPER_CANCEL_THRESHOLD: ${{ vars.SCRAPER_CANCEL_THRESHOLD }}
          SCRAPER_FIGHT_CANCEL_THRESHOLD: ${{ vars.SCRAPER_FIGHT_CANCEL_THRESHOLD }}
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          NEXT_PUBLIC_SENTRY_DSN: ${{ secrets.NEXT_PUBLIC_SENTRY_DSN }}

          # Tapology-first scraping configuration
          SCRAPER_SOURCE: 'tapology'
          SCRAPER_LIMIT: ${{ github.event.inputs.events_limit || '10' }}
          TAPOLOGY_ENRICH_RECORDS: 'true'

          # Disable Sherdog in CI to avoid GH IP blocks
          SHERDOG_ENABLED: 'false'
        run: |
          echo "ðŸš€ Starting Tapology-first automated scraper..."
          echo "ðŸ“Š Processing up to ${{ github.event.inputs.events_limit || '10' }} events"
          node scripts/automated-scraper.js check

      - name: Check scraper health (if scraper failed)
        if: failure()
        run: |
          echo "Scraper failed. Check logs above for details."
          echo "Common issues: Database connection, API rate limits, or source website changes."
