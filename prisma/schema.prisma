generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")        // For runtime (uses pooler)
  directUrl = env("DIRECT_DATABASE_URL") // For migrations (uses direct connection)
}

model Fighter {
  id                          String    @id @default(cuid())
  name                        String
  nickname                    String?
  wins                        Int       @default(0)
  losses                      Int       @default(0)
  draws                       Int       @default(0)
  weightClass                 String
  imageUrl                    String?
  record                      String?

  // Physical Attributes (from UFCStats.com)
  height                      String?   // e.g. "5' 11\"" - kept for display
  weightLbs                   Int?      // Weight in pounds
  reach                       String?   // e.g. "76\"" - kept for display
  reachInches                 Int?      // Reach in inches (parsed numeric)
  stance                      String?   // Orthodox, Southpaw, Switch
  dob                         String?   // Date of birth
  age                         Int?
  nationality                 String?

  // Striking Statistics (from UFCStats.com)
  significantStrikesPerMinute        Float @default(0) // SLpM
  significantStrikesLandedPerMinute  Float @default(0) // SLpM (alias for clarity)
  strikingAccuracyPercentage         Float @default(0) // Str. Acc. (0-1)
  significantStrikesAbsorbedPerMinute Float @default(0) // SApM
  strikingDefensePercentage          Float @default(0) // Sig. Str. Defence (0-1)

  // Grappling Statistics (from UFCStats.com)
  takedownAverage            Float @default(0) // TD Avg. (per 15 min)
  takedownAccuracy           Float @default(0) // Legacy field (kept for compatibility)
  takedownAccuracyPercentage Float @default(0) // TD Acc. (0-1)
  takedownDefensePercentage  Float @default(0) // TD Def. (0-1)
  submissionAverage          Float @default(0) // Sub. Avg. (per 15 min)

  // Win Methods & Fight Averages (from UFCStats.com)
  winsByKO                   Int   @default(0) // Wins by KO/TKO
  winsBySubmission           Int   @default(0) // Wins by Submission
  winsByDecision             Int   @default(0) // Wins by Decision
  averageFightTime           Int   @default(0) // Legacy field (kept for compatibility)
  averageFightTimeSeconds    Int   @default(0) // Avg fight time in seconds (MM:SS converted)

  // Calculated Statistics (derived from win methods)
  finishRate                 Float @default(0) // (KO + Sub) / Total Wins
  koPercentage               Float @default(0) // KO / Total Wins
  submissionPercentage       Float @default(0) // Sub / Total Wins

  // Legacy fields (to be deprecated eventually)
  currentStreak              String?
  ranking                    Int?
  socialFollowers            Int     @default(0)
  recentBuzzScore            Float   @default(0)
  fanFavorite                Boolean @default(false)
  funScore                   Float   @default(0)
  fightingStyles             String  @default("[]")
  lastFightDate              DateTime?

  // Scraper metadata
  sourceUrl                  String?   @unique
  lastScrapedAt              DateTime?
  contentHash                String?
  createdAt                  DateTime  @default(now())
  updatedAt                  DateTime  @updatedAt

  // Relations
  fighter1Fights             Fight[]   @relation("Fighter1")
  fighter2Fights             Fight[]   @relation("Fighter2")

  @@map("fighters")
}

model Event {
  id              String            @id @default(cuid())
  name            String
  date            DateTime
  location        String
  venue           String
  completed       Boolean           @default(false)
  cancelled       Boolean           @default(false)
  // New scraper fields
  sourceUrl       String?           @unique
  lastScrapedAt   DateTime?
  contentHash     String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  fights          Fight[]
  predictionUsage PredictionUsage[]

  @@map("events")
}

model Fight {
  id                  String   @id @default(cuid())
  fighter1Id          String
  fighter2Id          String
  eventId             String
  weightClass         String
  titleFight          Boolean  @default(false)
  mainEvent           Boolean  @default(false)
  cardPosition        String   @default("preliminary")
  scheduledRounds     Int      @default(3)
  fightNumber         Int?

  // Legacy AI prediction fields (to be deprecated)
  funFactor           Int      @default(0)
  finishProbability   Int      @default(0)
  entertainmentReason String?
  keyFactors          String   @default("[]")
  fightPrediction     String?
  riskLevel           String?
  predictedFunScore   Float    @default(0)
  funFactors          String   @default("[]")
  aiDescription       String?

  // Fight outcome data
  completed           Boolean  @default(false)
  actualFunScore      Float?
  winnerId            String?
  method              String?  // KO, TKO, SUB, DEC
  round               Int?
  time                String?
  bookingDate         DateTime @default(now())

  // Scraper metadata
  sourceUrl           String?  @unique
  lastScrapedAt       DateTime?
  contentHash         String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  event               Event       @relation(fields: [eventId], references: [id])
  fighter1            Fighter     @relation("Fighter1", fields: [fighter1Id], references: [id])
  fighter2            Fighter     @relation("Fighter2", fields: [fighter2Id], references: [id])
  predictions         Prediction[] // New AI prediction system

  @@map("fights")
}

model FunScoreHistory {
  id             String   @id @default(cuid())
  fightId        String
  predictedScore Float
  actualScore    Float?
  accuracy       Float?
  modelVersion   String
  createdAt      DateTime @default(now())

  @@map("fun_score_history")
}

model PredictionModel {
  id               String   @id @default(cuid())
  version          String   @unique
  finishRateWeight Float    @default(0.3)
  stylisticWeight  Float    @default(0.25)
  popularityWeight Float    @default(0.15)
  stakesWeight     Float    @default(0.2)
  historicalWeight Float    @default(0.1)
  confidence       Float    @default(0)
  trainingAccuracy Float    @default(0)
  active           Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@map("prediction_models")
}

model PredictionUsage {
  id                        String   @id @default(cuid())
  eventId                   String
  eventName                 String
  fightsProcessed           Int
  chunks                    Int
  promptTokensEstimated     Int
  completionTokensEstimated Int
  totalTokensEstimated      Int
  source                    String
  createdAt                 DateTime @default(now())
  event                     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@map("prediction_usage")
}

model QueryMetric {
  id          String   @id @default(cuid())
  query       String   // Normalized query pattern
  model       String?  // Prisma model name (Event, Fight, etc.)
  action      String?  // Prisma action (findMany, create, etc.)
  duration    Int      // Query duration in milliseconds
  performance String   // Performance classification: fast, moderate, slow, critical
  timestamp   DateTime @default(now())
  createdAt   DateTime @default(now()) @map("created_at")

  // Indexes for efficient querying
  @@index([timestamp])
  @@index([performance])
  @@index([model, action])
  @@map("query_metrics")
}

model ScrapeLog {
  id            String   @id @default(cuid())
  startTime     DateTime
  endTime       DateTime?
  status        String   // "SUCCESS" | "FAILURE" | "IN_PROGRESS"
  eventsFound   Int      @default(0)
  fightsAdded   Int      @default(0)
  fightsUpdated Int      @default(0)
  fightersAdded Int      @default(0)
  errorMessage  String?  @db.Text
  createdAt     DateTime @default(now())

  @@index([startTime])
  @@index([status])
  @@map("scrape_logs")
}

// New AI Prediction System Models

model PredictionVersion {
  id                  String   @id @default(cuid())
  version             String   @unique // e.g. "v1.0", "v1.1"
  finishPromptHash    String            // SHA256 of finish probability prompt template
  funScorePromptHash  String            // SHA256 of fun score prompt template
  description         String   @db.Text // What changed in this version
  active              Boolean  @default(false)
  createdAt           DateTime @default(now())

  // Accuracy metrics (updated after events complete)
  finishAccuracy      Float?   // % of finish predictions correct (threshold 0.5)
  brierScore          Float?   // Calibration score for probabilities (lower = better)
  funScoreCorrelation Float?   // Correlation with FOTN awards
  evaluatedAt         DateTime? // When metrics were last calculated

  // Relations
  predictions         Prediction[]

  @@index([active])
  @@index([createdAt])
  @@map("prediction_versions")
}

model Prediction {
  id        String   @id @default(cuid())
  fightId   String
  versionId String

  // Finish Probability Prediction
  finishProbability Float // 0-1 (0-100%)
  finishConfidence  Float // 0-1
  finishReasoning   Json  // Chain-of-thought steps: { defensive_comparison, finish_rate_comparison, etc. }

  // Fun Score Prediction
  funScore     Float // 0-100
  funConfidence Float // 0-1
  funBreakdown Json  // Score breakdown: { pace_score, finish_rate_score, style_matchup_score, etc. }

  // Metadata
  modelUsed String // "claude-3-5-sonnet-20241022", "gpt-4o", etc.
  tokensUsed Int   @default(0)
  costUsd   Float  @default(0)
  createdAt DateTime @default(now())

  // Evaluation (filled after fight completes)
  actualFinish            Boolean? // Did fight end in finish (KO/TKO/SUB)?
  actualFinishMethod      String?  // KO, TKO, SUB, DEC
  actualFunScore          Float?   // Manual rating or calculated from metrics
  finishPredictionCorrect Boolean? // Was the finish prediction correct?

  // Relations
  fight   Fight             @relation(fields: [fightId], references: [id], onDelete: Cascade)
  version PredictionVersion @relation(fields: [versionId], references: [id])

  @@unique([fightId, versionId]) // One prediction per fight per version
  @@index([versionId])
  @@index([createdAt])
  @@index([actualFinish]) // For evaluation queries
  @@map("predictions")
}
