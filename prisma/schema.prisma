generator client {
  provider = "prisma-client-js"
  // Force regeneration for loss statistics fields (Nov 13, 2025)
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")        // For runtime (uses pooler)
  directUrl = env("DIRECT_DATABASE_URL") // For migrations (uses direct connection)
}

model Fighter {
  id                          String    @id @default(cuid())
  name                        String
  nickname                    String?
  wins                        Int       @default(0)
  losses                      Int       @default(0)
  draws                       Int       @default(0)
  weightClass                 String
  imageUrl                    String?
  record                      String?

  // Physical Attributes (from UFCStats.com)
  height                      String?   // e.g. "5' 11\"" - kept for display
  weightLbs                   Int?      // Weight in pounds
  reach                       String?   // e.g. "76\"" - kept for display
  reachInches                 Int?      // Reach in inches (parsed numeric)
  stance                      String?   // Orthodox, Southpaw, Switch
  dob                         String?   // Date of birth
  age                         Int?
  nationality                 String?

  // Striking Statistics (from UFCStats.com)
  significantStrikesPerMinute        Float @default(0) // SLpM
  significantStrikesLandedPerMinute  Float @default(0) // SLpM (alias for clarity)
  strikingAccuracyPercentage         Float @default(0) // Str. Acc. (0-1)
  significantStrikesAbsorbedPerMinute Float @default(0) // SApM
  strikingDefensePercentage          Float @default(0) // Sig. Str. Defence (0-1)

  // Grappling Statistics (from UFCStats.com)
  takedownAverage            Float @default(0) // TD Avg. (per 15 min)
  takedownAccuracy           Float @default(0) // Legacy field (kept for compatibility)
  takedownAccuracyPercentage Float @default(0) // TD Acc. (0-1)
  takedownDefensePercentage  Float @default(0) // TD Def. (0-1)
  submissionAverage          Float @default(0) // Sub. Avg. (per 15 min)

  // Win Methods & Fight Averages (from UFCStats.com)
  winsByKO                   Int   @default(0) // Wins by KO/TKO
  winsBySubmission           Int   @default(0) // Wins by Submission
  winsByDecision             Int   @default(0) // Wins by Decision
  averageFightTime           Int   @default(0) // Legacy field (kept for compatibility)
  averageFightTimeSeconds    Int   @default(0) // Avg fight time in seconds (MM:SS converted)

  // Loss Methods (from UFCStats.com fight history)
  lossesByKO                 Int   @default(0) // Losses by KO/TKO
  lossesBySubmission         Int   @default(0) // Losses by Submission
  lossesByDecision           Int   @default(0) // Losses by Decision

  // Calculated Statistics (derived from win methods)
  finishRate                 Float @default(0) // (KO + Sub) / Total Wins
  koPercentage               Float @default(0) // KO / Total Wins
  submissionPercentage       Float @default(0) // Sub / Total Wins

  // Calculated Loss Statistics (derived from loss methods)
  lossFinishRate             Float @default(0) // (KO losses + Sub losses) / Total Losses
  koLossPercentage           Float @default(0) // KO losses / Total Losses
  submissionLossPercentage   Float @default(0) // Sub losses / Total Losses

  // Legacy fields (to be deprecated eventually)
  currentStreak              String?
  ranking                    Int?
  socialFollowers            Int     @default(0)
  recentBuzzScore            Float   @default(0)
  fanFavorite                Boolean @default(false)
  funScore                   Float   @default(0)
  fightingStyles             String  @default("[]")
  lastFightDate              DateTime?

  // Scraper metadata
  sourceUrl                  String?   @unique
  lastScrapedAt              DateTime?
  contentHash                String?
  createdAt                  DateTime  @default(now())
  updatedAt                  DateTime  @updatedAt

  // Embedding/RAG fields (vector column managed via raw SQL)
  profileText                String?   @map("profile_text") @db.Text  // Text summary for embedding
  embeddingUpdatedAt         DateTime? @map("embedding_updated_at")
  // Note: profile_embedding (vector) and search_vector (tsvector) are managed via raw SQL

  // Relations
  fighter1Fights             Fight[]   @relation("Fighter1")
  fighter2Fights             Fight[]   @relation("Fighter2")
  contextChunks              FighterContextChunk[]
  entertainmentProfile       FighterEntertainmentProfile?

  @@map("fighters")
}

model Event {
  id              String            @id @default(cuid())
  name            String
  date            DateTime
  location        String
  venue           String
  completed       Boolean           @default(false)
  cancelled       Boolean           @default(false)
  // New scraper fields
  sourceUrl       String?           @unique
  lastScrapedAt   DateTime?
  contentHash     String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  fights          Fight[]
  predictionUsage PredictionUsage[]

  @@map("events")
}

model Fight {
  id                  String   @id @default(cuid())
  fighter1Id          String
  fighter2Id          String
  eventId             String
  weightClass         String
  titleFight          Boolean  @default(false)
  mainEvent           Boolean  @default(false)
  cardPosition        String   @default("preliminary")
  scheduledRounds     Int      @default(3)
  fightNumber         Int?

  // Legacy AI prediction fields (to be deprecated)
  funFactor           Int      @default(0)
  finishProbability   Int      @default(0)
  entertainmentReason String?
  keyFactors          String   @default("[]")
  fightPrediction     String?
  riskLevel           String?
  predictedFunScore   Float    @default(0)
  funFactors          String   @default("[]")
  aiDescription       String?

  // ML Tier Model Prediction (pre-computed from fighter statistics)
  // Used as objective baseline for entertainment prediction
  mlTier              Int?     // 1-5: Low, Average, Good, Excellent, Elite
  mlTierConfidence    Float?   // 0-1: model confidence in tier prediction
  mlTierProbabilities Json?    // Array of 5 probabilities [P(T1),...,P(T5)]
  mlTierComputedAt    DateTime? // When ML tier was last computed

  // Fight outcome data
  completed           Boolean  @default(false)
  isCancelled         Boolean  @default(false)
  actualFunScore      Float?
  winnerId            String?
  method              String?  // KO, TKO, SUB, DEC
  round               Int?
  time                String?
  bookingDate         DateTime @default(now())

  // Scraper metadata
  sourceUrl           String?  @unique
  lastScrapedAt       DateTime?
  contentHash         String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  event               Event       @relation(fields: [eventId], references: [id])
  fighter1            Fighter     @relation("Fighter1", fields: [fighter1Id], references: [id])
  fighter2            Fighter     @relation("Fighter2", fields: [fighter2Id], references: [id])
  predictions         Prediction[] // New AI prediction system
  weakLabel           WeakSupervisionLabel? // Phase 2: Calibration weak supervision label
  predictionLogs      PredictionLog[] // Phase 4: Prediction logging for calibration

  // Prevent duplicate fights for same event and fighter pairing
  @@unique([eventId, fighter1Id, fighter2Id])
  @@map("fights")
}

model FunScoreHistory {
  id             String   @id @default(cuid())
  fightId        String
  predictedScore Float
  actualScore    Float?
  accuracy       Float?
  modelVersion   String
  createdAt      DateTime @default(now())

  @@map("fun_score_history")
}

model PredictionModel {
  id               String   @id @default(cuid())
  version          String   @unique
  finishRateWeight Float    @default(0.3)
  stylisticWeight  Float    @default(0.25)
  popularityWeight Float    @default(0.15)
  stakesWeight     Float    @default(0.2)
  historicalWeight Float    @default(0.1)
  confidence       Float    @default(0)
  trainingAccuracy Float    @default(0)
  active           Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@map("prediction_models")
}

model PredictionUsage {
  id                        String   @id @default(cuid())
  eventId                   String
  eventName                 String
  fightsProcessed           Int
  chunks                    Int
  promptTokensEstimated     Int
  completionTokensEstimated Int
  totalTokensEstimated      Int
  source                    String
  createdAt                 DateTime @default(now())
  event                     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@map("prediction_usage")
}

model QueryMetric {
  id          String   @id @default(cuid())
  query       String   // Normalized query pattern
  model       String?  // Prisma model name (Event, Fight, etc.)
  action      String?  // Prisma action (findMany, create, etc.)
  duration    Int      // Query duration in milliseconds
  performance String   // Performance classification: fast, moderate, slow, critical
  timestamp   DateTime @default(now())
  createdAt   DateTime @default(now()) @map("created_at")

  // Indexes for efficient querying
  @@index([timestamp])
  @@index([performance])
  @@index([model, action])
  @@map("query_metrics")
}

model ScrapeLog {
  id               String   @id @default(cuid())
  startTime        DateTime
  endTime          DateTime?
  status           String   // "SUCCESS" | "FAILURE" | "IN_PROGRESS"
  eventsFound      Int      @default(0)
  fightsAdded      Int      @default(0)
  fightsUpdated    Int      @default(0)
  fightsCancelled  Int      @default(0)
  fightersAdded    Int      @default(0)
  errorMessage     String?  @db.Text
  createdAt        DateTime @default(now())

  @@index([startTime])
  @@index([status])
  @@map("scrape_logs")
}

// New AI Prediction System Models

model PredictionVersion {
  id                  String   @id @default(cuid())
  version             String   @unique // e.g. "v1.0", "v1.1"
  finishPromptHash    String            // SHA256 of finish probability prompt template
  funScorePromptHash  String            // SHA256 of fun score prompt template
  description         String   @db.Text // What changed in this version
  active              Boolean  @default(false)
  createdAt           DateTime @default(now())

  // Accuracy metrics (updated after events complete)
  finishAccuracy      Float?   // % of finish predictions correct (threshold 0.5)
  brierScore          Float?   // Calibration score for probabilities (lower = better)
  funScoreCorrelation Float?   // Correlation with FOTN awards
  evaluatedAt         DateTime? // When metrics were last calculated

  // Relations
  predictions         Prediction[]

  @@index([active])
  @@index([createdAt])
  @@map("prediction_versions")
}

model Prediction {
  id        String   @id @default(cuid())
  fightId   String
  versionId String

  // Finish Probability Prediction
  finishProbability Float // 0-1 (0-100%)
  finishConfidence  Float // 0-1
  finishReasoning   Json  // Chain-of-thought steps: { defensive_comparison, finish_rate_comparison, etc. }

  // Fun Score Prediction
  funScore     Float // 0-100
  funConfidence Float // 0-1
  funBreakdown Json  // Score breakdown: { pace_score, finish_rate_score, style_matchup_score, etc. }

  // ML Tier Model Prediction (from trained XGBoost classifier)
  // Provides objective baseline for comparison with LLM predictions
  mlTier            Int?   // 1-5: Low, Average, Good, Excellent, Elite
  mlTierConfidence  Float? // 0-1: model confidence in tier prediction
  mlTierProbabilities Json? // Array of 5 probabilities for each tier [P(T1),...,P(T5)]

  // Metadata
  modelUsed String // "claude-3-5-sonnet-20241022", "gpt-4o", etc.
  tokensUsed Int   @default(0)
  costUsd   Float  @default(0)
  createdAt DateTime @default(now())

  // Evaluation (filled after fight completes)
  actualFinish            Boolean? // Did fight end in finish (KO/TKO/SUB)?
  actualFinishMethod      String?  // KO, TKO, SUB, DEC
  actualFunScore          Float?   // Manual rating or calculated from metrics
  finishPredictionCorrect Boolean? // Was the finish prediction correct?

  // Relations
  fight   Fight             @relation(fields: [fightId], references: [id], onDelete: Cascade)
  version PredictionVersion @relation(fields: [versionId], references: [id])

  @@unique([fightId, versionId]) // One prediction per fight per version
  @@index([versionId])
  @@index([createdAt])
  @@index([actualFinish]) // For evaluation queries
  @@map("predictions")
}

// ============================================
// PHASE 2: CALIBRATION INFRASTRUCTURE
// ============================================

model CalibrationParams {
  id                String   @id @default(cuid())
  predictionType    String   // "finish" (Platt) or "fun" (Conformal)

  // Platt scaling params (for finish probability - binary classification)
  paramA            Float?   // Logistic regression slope
  paramB            Float?   // Logistic regression intercept

  // Conformal prediction params (for fun score - continuous)
  conformityScores  Json?    // Array of historical residuals [number[]]
  coverageLevel     Float?   // Target coverage, e.g., 0.90 for 90% CI

  // Training metadata
  trainedOn         Int      // Number of samples used for training
  trainingWindow    String?  // e.g., "6_months", "12_months"

  // Calibration metrics (before/after applying calibration)
  brierScoreBefore  Float?   // Mean squared error before calibration
  brierScoreAfter   Float?   // Mean squared error after calibration
  eceScore          Float?   // Expected Calibration Error
  mceScore          Float?   // Maximum Calibration Error

  // Lifecycle
  active            Boolean  @default(false)
  validFrom         DateTime
  validTo           DateTime
  createdAt         DateTime @default(now())

  @@index([predictionType, active])
  @@map("calibration_params")
}

model WeakSupervisionLabel {
  id                    String   @id @default(cuid())
  fightId               String   @unique

  // Binary ground truth
  actualFinish          Boolean  // True if fight ended in KO/TKO/SUB

  // Entertainment label from labeling functions
  entertainmentLabel    String   // "HIGH", "MEDIUM", "LOW", "ABSTAIN"
  entertainmentScore    Float?   // Aggregated score from labeling functions (0-100)
  entertainmentConfidence Float  // Confidence in the label (0-1)

  // Which labeling functions contributed
  contributingFunctions String[] // e.g., ["high_action", "quick_finish", "bonus_winner"]
  functionVotes         Json?    // Detailed votes: { "high_action": "HIGH", "bonus_winner": "HIGH" }

  // Raw metrics used for labeling (from fight stats)
  significantStrikes    Int?     // Total significant strikes landed
  knockdowns            Int?     // Total knockdowns in the fight
  finishRound           Int?     // Which round the fight ended (null if decision)
  totalFightTimeSeconds Int?     // Fight duration
  bonusAwarded          Boolean? // Fight of the Night / Performance of the Night
  controlTime           Int?     // Ground control time in seconds

  // Metadata
  labeledAt             DateTime @default(now())
  labelingVersion       String?  // Version of labeling functions used

  // Relations
  fight                 Fight    @relation(fields: [fightId], references: [id], onDelete: Cascade)

  @@map("weak_supervision_labels")
}

// ============================================
// PHASE 3: RAG INFRASTRUCTURE
// ============================================

model FighterContextChunk {
  id          String    @id @default(cuid())
  fighterId   String    @map("fighter_id")
  content     String    @db.Text
  contentType String    @map("content_type")  // 'news', 'analysis', 'fight_history', 'training_camp'
  sourceUrl   String?   @map("source_url")
  publishedAt DateTime? @map("published_at")
  expiresAt   DateTime? @map("expires_at")    // For time-sensitive content
  createdAt   DateTime  @default(now()) @map("created_at")
  // Note: embedding (vector) and search_vector (tsvector) are managed via raw SQL

  // Relations
  fighter     Fighter   @relation(fields: [fighterId], references: [id], onDelete: Cascade)

  @@index([fighterId])
  @@index([contentType])
  @@index([expiresAt])
  @@map("fighter_context_chunks")
}

// ============================================
// PHASE 4: PREDICTION LOGGING
// ============================================

model PredictionLog {
  id                          String    @id @default(cuid())
  fightId                     String    @map("fight_id")

  // Raw predictions from LLM
  rawFinishProbability        Float     @map("raw_finish_probability")
  calibratedFinishProbability Float     @map("calibrated_finish_probability")
  finishConfidence            Float     @map("finish_confidence")

  rawFunScore                 Int       @map("raw_fun_score")
  funScoreLower               Float?    @map("fun_score_lower")  // Conformal interval
  funScoreUpper               Float?    @map("fun_score_upper")  // Conformal interval
  funConfidence               Float     @map("fun_confidence")

  // Model info
  modelUsed                   String    @map("model_used")
  tokensUsed                  Int       @map("tokens_used")
  costUsd                     Float     @map("cost_usd")

  // Actual outcomes (filled in after fight completes)
  actualFinish                Boolean?  @map("actual_finish")      // true = finish, false = decision
  actualEntertainment         String?   @map("actual_entertainment") // 'HIGH', 'MEDIUM', 'LOW' from weak supervision

  // Metadata
  createdAt                   DateTime  @default(now()) @map("created_at")
  evaluatedAt                 DateTime? @map("evaluated_at")

  // Relations
  fight                       Fight     @relation(fields: [fightId], references: [id], onDelete: Cascade)

  @@index([fightId])
  @@index([createdAt])
  @@index([actualFinish])
  @@map("prediction_logs")
}

// ============================================
// PHASE 5: FIGHTER ENTERTAINMENT PROFILES
// Cached web search extractions for prediction enrichment
// ============================================

model FighterEntertainmentProfile {
  id                     String   @id @default(cuid())
  fighterId              String   @unique @map("fighter_id")

  // Archetype classification
  primaryArchetype       String   @map("primary_archetype")      // brawler, pressure_fighter, counter_striker, etc.
  secondaryArchetype     String?  @map("secondary_archetype")
  archetypeReasoning     String   @map("archetype_reasoning") @db.Text
  archetypeConfidence    Int      @map("archetype_confidence")   // 0-100

  // Entertainment mentality
  mentality              String                                   // finisher, coasts_with_lead, bonus_hunter, plays_safe
  mentalityReasoning     String   @map("mentality_reasoning") @db.Text
  mentalityConfidence    Int      @map("mentality_confidence")   // 0-100

  // Reputation & history (stored as JSON)
  reputationTags         String[] @map("reputation_tags")        // ["always comes forward", "iron chin", etc.]
  notableWars            Json?    @map("notable_wars")           // Array of { opponent, event, year, description, result }
  bonusHistory           Json?    @map("bonus_history")          // { fotn_count, potn_count, total_bonuses, bonus_rate_estimate }
  knownBoringFights      String[] @map("known_boring_fights")    // ["vs. Opponent (note)", ...]
  rivalries              Json?                                   // Array of { opponent, is_real_beef, context }

  // Overall assessment
  entertainmentPrediction String  @map("entertainment_prediction") // high, medium, low, unknown
  extractionNotes        String?  @map("extraction_notes") @db.Text

  // Search metadata
  sources                String[] @default([])                   // URLs used for extraction
  searchTokens           Int      @default(0) @map("search_tokens")
  extractionTokens       Int      @default(0) @map("extraction_tokens")
  totalCostUsd           Float    @default(0) @map("total_cost_usd")

  // Lifecycle
  searchedAt             DateTime @map("searched_at")            // When profile was extracted
  expiresAt              DateTime @map("expires_at")             // When to refresh (6 months from searchedAt)
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @updatedAt @map("updated_at")

  // Relations
  fighter                Fighter  @relation(fields: [fighterId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@index([entertainmentPrediction])
  @@map("fighter_entertainment_profiles")
}
